var Nav = function () {
	
	return { init: init };
	
	function init () {
		$('.p-statistical .nav-statistical').addClass('active');
			$('.p-statistical-collectionshare .nav-statistical-collectionshare').addClass('active'); 
			$('.p-statistical-comments .nav-statistical-comments').addClass('active');
			$('.p-statistical-member .nav-statistical-member').addClass('active');
			$('.p-statistical-tender .nav-statistical-tender').addClass('active');   
			$('.p-statistical-site .nav-statistical-site').addClass('active'); 
			$('.p-statistical-index .nav-statistical-index').addClass('active');
			$('.p-statistical-commission .nav-statistical-commission').addClass('active');		
			$('.p-statistical-active .nav-statistical-active').addClass('active');
			$('.p-statistical-grabsingle .nav-statistical-grabsingle').addClass('active');
			$('.p-statistical-publishorder .nav-statistical-publishorder').addClass('active');
			$('.p-statistical-traderecord .nav-statistical-traderecord').addClass('active');
			
	    $('.p-agency .nav-agency').addClass('active');
		$('.p-order .nav-order').addClass('active');	
			$('.p-rushorder .nav-rushorder').addClass('active'); 
			$('.p-releaseorder .nav-releaseorder').addClass('active');	 
	    
		$('.p-casesitemanage .nav-casesitemanage').addClass('active');
			$('.p-casesitemanage-casemanage .nav-casesitemanage-casemanage').addClass('active');
			$('.p-casesitemanage-sitemanage .nav-casesitemanage-sitemanage').addClass('active');
			$('.p-casesitemanage-gallery .nav-casesitemanage-gallery').addClass('active');
		$('.p-inte .nav-inte').addClass('active');
			$('.p-inte-integain .nav-inte-integain').addClass('active');
			$('.p-inte-changerule .nav-inte-changerule').addClass('active');
			
		$('.p-trade .nav-trade').addClass('active');
		$('.p-notice_auto .nav-notice_auto').addClass('active');
			$('.p-trade-manage .nav-trade-manage').addClass('active');
			
		$('.p-financial .nav-financial').addClass('active');
			$('.p-financial-withdrawal-audit .nav-financial-withdrawal-audit').addClass('active');
			$('.p-financial-withdrawal-record .nav-financial-withdrawal-record').addClass('active');
			$('.p-financial-transaction-records .nav-financial-transaction-records').addClass('active');
			$('.p-financial-account-manage .nav-financial-account-manage').addClass('active');    
			$('.p-financial-number-count .nav-financial-number-count').addClass('active');    
			$('.p-financial-recharge-record .nav-financial-recharge-record').addClass('active');    
		 
		$('.p-information .nav-information').addClass('active');
			$('.p-information-appointmentList .nav-information-appointmentList').addClass('active');
			$('.p-information-tender .nav-information-tender').addClass('active');
			$('.p-information-massmessage .nav-information-massmessage').addClass('active');
			$('.p-information-quotationList .nav-information-quotationList').addClass('active');  
			
		$('.p-dashboard .nav-dashboard').addClass('active');
		$('.p-audit .nav-audit').addClass('active');	 
			$('.p-audit-au .nav-audit-au').addClass('active');
			$('.p-audit-des .nav-audit-des').addClass('active');
			$('.p-audit-case .nav-audit-case').addClass('active');
			$('.p-audit-info .nav-audit-info').addClass('active');
			$('.p-audit-complaints .nav-audit-complaints').addClass('active');
			$('.p-audit-reprotcase .nav-audit-reprotcase').addClass('active');
			$('.p-audit-tender .nav-audit-tender').addClass('active'); 
		
		$('.p-homepage .nav-homepage').addClass('active');
			$('.p-homepage-banner .nav-homepage-banner').addClass('active');
			$('.p-homepage-tender .nav-homepage-tender').addClass('active');
			$('.p-homepage-design .nav-homepage-design').addClass('active');
			
			$('.p-homepage-banner2 .nav-homepage-banner2').addClass('active');
			$('.p-online-complaints .nav-online-complaints').addClass('active'); 
			
		$('.p-decorationcompan .nav-decorationcompan').addClass('active');	 
			$('.p-decorationcompan-list .nav-decorationcompan-list').addClass('active');
			$('.p-decorationcompan-gc .nav-decorationcompan-gc').addClass('active');
		
		$('.p-xingyi .nav-xingyi').addClass('active');	
			$('.p-xingyi-tender .nav-xingyi-tender').addClass('active');
			$('.p-xingyi-designer .nav-xingyi-designer').addClass('active');
			$('.p-xingyi-company .nav-xingyi-company').addClass('active');
			
		$('.p-system .nav-system').addClass('active');	
			$('.p-system-user .nav-system-user').addClass('active');
			$('.p-system-role .nav-system-role').addClass('active');
			$('.p-system-func .nav-system-func').addClass('active');
			$('.p-system-dict-type .nav-system-dict-type').addClass('active');
			$('.p-system-dict .nav-system-dict').addClass('active');
			$('.p-system-suggest .nav-system-suggest').addClass('active');
			$('.p-system-account .nav-system-account').addClass('active');
			$('.p-member .nav-member').addClass('active');
			$('.p-system-membercheck .nav-system-membercheck').addClass('active');
			$('.p-system-memberinstance .nav-system-memberinstance').addClass('active');
			
	
		$('.p-setting .nav-setting').addClass('active');	
			$('.p-setting-dict-province .nav-setting-dict-province').addClass('active');
			$('.p-setting-site .nav-setting-site').addClass('active');
			$('.p-system-problem .nav-system-problem').addClass('active');
			$('.p-setting-qiniu .nav-setting-qiniu').addClass('active'); 
			$('.p-setting-index .nav-setting-index').addClass('active');
			$('.p-setting-search .nav-setting-search').addClass('active');
			$('.p-notice .nav-notice').addClass('active');
			$('.p-dictionarie .nav-dictionarie').addClass('active');
			$('.p-complaint .nav-complaint').addClass('active');
			
		$('.p-suppe .nav-suppe').addClass('active');
			$('.p-suppe-manage .nav-suppe-manage').addClass('active');
			

		
		$('.p-wxmanage .nav-wxmanage').addClass('active');	
			$('.p-wxmanage-owner .nav-wxmanage-owner').addClass('active');
			$('.p-wxmanage-designe .nav-wxmanage-designe').addClass('active');
			
		$('.p-hsy .nav-hsy').addClass('active');	
			$('.p-hsy-mzjc .nav-hsy-mzjc ').addClass('active');
			$('.p-hsy-hsjy .nav-hsy-hsjy ').addClass('active');
			$('.p-hsy-zpyx .nav-hsy-zpyx ').addClass('active');
			$('.p-hsy-tj .nav-hsy-tj ').addClass('active'); 
			$('.p-hsy-actprize .nav-hsy-actprize ').addClass('active'); 
			$('.p-hsy-hsyzdjc .nav-hsy-hsyzdjc').addClass('active');
			$('.p-hsy-zdjctj .nav-hsy-zdjctj').addClass('active');
			$('.p-hsy-getprizetj .nav-hsy-getprizetj').addClass('active');
			
	    $('.p-activity .nav-activity').addClass('active');
		$('.p-activity-shenye .nav-activity-shenye').addClass('active');
		$('.p-game-game .nav-game-game').addClass('active');
		$('.p-game-gameInterface .nav-game-gameInterface').addClass('active');
		$('.p-textkey .nav-textkey').addClass('active');
			$('.p-textkey-list .nav-textkey-list').addClass('active');
			$('.p-textkey-question .nav-textkey-question').addClass('active');
			$('.p-textkey-guaguaka .nav-textkey-guaguaka').addClass('active');
			$('.p-textkey-coupon .nav-textkey-coupon').addClass('active');
			$('.p-message-hello .nav-message-hello').addClass('active');
			$('.p-message-list .nav-message-list').addClass('active');
			$('.p-inte-bycar .nav-inte-bycar').addClass('active');
			$('.p-member-mark .nav-member-mark').addClass('active');
			$('.p-textkey-l2s .nav-textkey-l2s').addClass('active');
		$('.p-audit .nav-audit').addClass('active');
			$('.p-audit-qrcode .nav-audit-qrcode').addClass('active');
			$('.p-audit-view .nav-audit-view').addClass('active');
			$('.p-audit-act .nav-audit-act').addClass('active');
			$('.p-audit-jr .nav-audit-jr').addClass('active');
			$('.p-audit-banner .nav-audit-banner').addClass('active');
			$('.p-audit-banner-charg .nav-audit-banner-charg').addClass('active');
			$('.p-inte-validate .nav-inte-validate').addClass('active');
			$('.p-admin-dtmenu .nav-admin-dtmenu').addClass('active');
			$('.p-resource .nav-resource').addClass('active');
			$('.p-resource-photo .nav-resource-photo').addClass('active');
			$('.p-notice-send .nav-notice-send').addClass('active');
			$('.p-audit-dec .nav-audit-dec').addClass('active');
			
			
		$('.p-inte .nav-inte').addClass('active');
			$('.p-inte-gain .nav-inte-gain').addClass('active');
			$('.p-inte-change .nav-inte-change').addClass('active');
			
		$('.p-member .nav-member').addClass('active');
		$('.p-member-menu .nav-member-menu').addClass('active');
		
		$('.p-kfmanager .nav-kfmanager').addClass('active');
		$('.p-evaluate .nav-evaluate').addClass('active');
			 
		$('.p-priv .nav-priv').addClass('active');
			$('.p-admin-user .nav-admin-user').addClass('active');
			$('.p-admin-role .nav-admin-role').addClass('active');
			$('.p-admin-menu .nav-admin-menu').addClass('active');
		$('.p-report .nav-report').addClass('active');
			$('.p-report-statis .nav-report-statis').addClass('active');
		$('.p-weixin .nav-weixin').addClass('active');
			$('.p-weixin-menu .nav-weixin-menu').addClass('active');
			$('.p-weixin-reply .nav-weixin-reply').addClass('active');
			$('.p-weixin-qunfa .nav-weixin-qunfa').addClass('active');
			$('.p-weixin-audit .nav-weixin-audit').addClass('active');
			$('.p-weixin-sucai .nav-weixin-sucai').addClass('active');
			
		$('.p-other .nav-other').addClass('active'); 
			$('.p-other-offer .nav-other-offer').addClass('active');
			
		$('.p-statistics .nav-statistics').addClass('active');
		$('.p-statistics-addmember .nav-statistics-addmember').addClass('active');
			 
		/*$('.p-dashboard .p_dashboard').addClass('active'); */
			
		var mainnav = $('.main-nav'),
			openActive = mainnav.is ('.open-active'),
			navActive = mainnav.find ('> .active');

		mainnav.find ('> .dropdown > a').bind ('click', navClick);

		if (openActive && navActive.is ('.dropdown')) {			
			navActive.addClass ('opened').find ('.sub-nav').show ();
		}
	}
	
	function navClick (e) {
		e.preventDefault ();
		var li = $(this).parents ('li');		
		if (li.is ('.opened')) { 
			closeAll ();
		} else { 
			closeAll ();
			li.addClass ('opened').find ('.sub-nav').slideDown ();
		}
	}

	function closeAll () {	
		$('.sub-nav').slideUp ().parents ('li').removeClass ('opened');
	}
}();

var App = function () {
	"use strict";	
	return { init: init,  debounce: debounce };
	function init () {
		initLayout ();	
		initAutosize ();
		initFormValidation ();
		initSelect2 ();		
		initDatepicker ();
		initTimepicker ();
		initTooltips ();
		initICheck ();
		initTableCheckable ();
		//initDataTableHelper ();
	}

	function initLayout () {
		Nav.init ();	
		$('body').on('touchstart.dropdown', '.dropdown-menu', function (e) { 
		    e.stopPropagation(); 
		});
		function bodySM (){
			if ($(window).width() < 1024 ) {
				$('body').addClass('p-sm');
				$('.sidebar').addClass('sidebar-sm');
				$('.content').addClass('content-sm');
			} else {
				$('body').removeClass('p-sm');
				$('.sidebar').removeClass('sidebar-sm');
				$('.content').removeClass('content-sm');
			}		
		};
		bodySM();
		$(window).on('resize', bodySM);
	}

	function initAutosize () {
		if ($.fn.autosize) {
		$('.ui-textarea-autosize').each(function() {
			if($(this).data ('animate')) {
					$(this).addClass ('autosize-animate').autosize();
				} else {
					$(this).autosize();
				}
			});
		}
	}

	function initFormValidation () {
		if ($.fn.parsley) {
			$('.parsley-form').each (function () {
				$(this).parsley ({
					trigger: 'blur',
					validationMinlength: 0 ,
					errors: {
						container: function (element, isRadioOrCheckbox) {
							if (element.parents ('form').is ('.form-horizontal')) {
								return element.parents ("div[class^='col-']");
							}
							return element.parents ('.form-group');
						}
					},
					messages: {
					defaultMessage: "您的输入有误"
						, type: {
							email:      "请输入有效的电子邮件地址"
							, url:        "请输入有效的网络地址"
							, urlstrict:  "请输入有效的网络地址"
							, number:     "只允许输入数字"
							, digits:     "请输入数字"
							, dateIso:    "正确的日期格式为YYYY-MM-DD"
							, alphanum:   "只允许输入字母和数字"
							, phone:      "请输入有效的电话号码"
						}
						, notnull:        "必填项"
						, notblank:       "输入不能为空"
						, required:       "必填项"
						, regexp:         "输入的值不合法"
						, min:            "最小值为 %s"
						, max:            "允许的最大值为 %s"
						, range:          "%s - %s 位字符"
						, minlength:      "最少 %s 位字符"
						, maxlength:      "最多 %s 位字符"
						, rangelength:    "%s - %s 位字符"
						, mincheck:       "至少选择 %s 项"
						, maxcheck:       "最多选择 %s 项"
						, rangecheck:     "请选择 %s - %s 项"
						, equalto:        "两次输入不一致"
					}
				});
			});
			$('.modal').on('hidden.bs.modal', function () {
				$('.modal .parsley-form').parsley().reset();
			})				
		}
	}

	function initSelect2 () {
		if ($.fn.select2) {
			$('.select2-input').select2({ allowClear: true, placeholder: "Select..." });
		}
	}

	function initDatepicker () {
		if ($.fn.datepicker) { $('.ui-datepicker').datepicker ({ autoclose: true, todayHighlight: true }); }
	}

	function initTimepicker () {
		if ($.fn.timepicker) { 
			var pickers = $('.timepicker, .ui-timepicker, .ui-timepicker-modal');

			pickers.each (function () {
				$(this).parent ('.input-group').addClass ('bootstrap-timepicker');

				if ($(this).is ('.timepicker')) {
					$(this).timepicker ({ use24hours: true });
				} else {
					$(this).timepicker({ template: 'modal' });
				}	
			});		
		}
	}

	function initTooltips () {
		if ($.fn.tooltip) { $('.ui-tooltip').tooltip (); }
		if ($.fn.popover) { $('.ui-popover').popover ({ container: 'body' }); }
	}

	function initICheck () {
		if ($.fn.iCheck) {
			$('.icheck-input').iCheck({
				checkboxClass: 'ui-checkbox',
				radioClass: 'ui-radio',
				inheritClass: true
			}).on ('ifChanged', function (e) {
				$(e.currentTarget).trigger ('change');
			});
			$('.table-checkable tbody tr').on('click',function(){
				if ( $(this).children().hasClass('checkbox-column') ) {
					if ($(this).hasClass('checked')) {
						$(this).removeClass('checked').find('.icheck-input').removeAttr('checked').iCheck('update');
						$(this).parents('.table-checkable').find('thead .icheck-input').removeAttr('checked').iCheck('update');
					} else {
						$(this).addClass('checked').find('.icheck-input').prop('checked', true).iCheck('update');
						var hasChecbox = $(this).siblings().not('.checked').find('[type="checkbox"]');
						var hasRadio = $(this).siblings().find('[type="radio"]');
						if ( hasChecbox.length <= 0 ) {
							$(this).parents('.table-checkable').find('thead .icheck-input').prop('checked',true).iCheck('update');
						}						
						if ( hasRadio.length > 0 ) {
							$(hasRadio).parents('.table-checkable tbody tr').removeClass('checked');
							$(hasRadio).removeAttr('checked').iCheck('update');
						}						
					};
				}	else {
					$(this).addClass('checked');
					$(this).siblings().removeClass('checked');					
				}					
			})
		}
	}

	function initTableCheckable () {
		if ($.fn.tableCheckable) {
			$('.table-checkable')
		        .tableCheckable ()
			        .on ('masterChecked', function (event, master, slaves) { 
			            if ($.fn.iCheck) { $(slaves).iCheck ('update'); }
			        })
			        .on ('slaveChecked', function (event, master, slave) {
			            if ($.fn.iCheck) { $(master).iCheck ('update'); }
			        });
		}
	}

	function initDataTableHelper () {
		if ($.fn.dataTable) {
			$('[data-provide="datatable"]').each (function () {	
				$(this).addClass ('dataTable-helper');		
				var defaultOptions = {
						paginate: true,
						search: false,
						info: true,
						lengthChange: true,
						displayRows: 10
					},
					dataOptions = $(this).data (),
					helperOptions = $.extend (defaultOptions, dataOptions),
					$thisTable,
					tableConfig = {};

				tableConfig.iDisplayLength = helperOptions.displayRows;
				tableConfig.bFilter = true;
				tableConfig.bSort = true;
				tableConfig.bPaginate = false;
				tableConfig.bLengthChange = false;	
				tableConfig.bInfo = false;

				if (helperOptions.paginate) { tableConfig.bPaginate = true; }
				if (helperOptions.lengthChange) { tableConfig.bLengthChange = true; }
				if (helperOptions.info) { tableConfig.bInfo = true; }       
				if (helperOptions.search) { $(this).parent ().removeClass ('datatable-hidesearch'); }				

				tableConfig.aaSorting = [];
				tableConfig.aoColumns = [];

				$(this).find ('thead tr th').each (function (index, value) {
					var sortable = ($(this).data ('sortable') === true) ? true : false;
					tableConfig.aoColumns.push ({ 'bSortable': sortable });

					if ($(this).data ('direction')) {
						tableConfig.aaSorting.push ([index, $(this).data ('direction')]);
					}
				});		
				
				// Create the datatable
				$thisTable = $(this).dataTable (tableConfig);

				if (!helperOptions.search) {
					$thisTable.parent ().find ('.dataTables_filter').remove ();
				}

				var filterableCols = $thisTable.find ('thead th').filter ('[data-filterable="true"]');

				if (filterableCols.length > 0) {
					var columns = $thisTable.fnSettings().aoColumns,
						$row, th, $col, showFilter;

					$row = $('<tr>', { cls: 'dataTable-filter-row' }).appendTo ($thisTable.find ('thead'));

					for (var i=0; i<columns.length; i++) {
						$col = $(columns[i].nTh.outerHTML);
						showFilter = ($col.data ('filterable') === true) ? 'show' : 'hide';

						th = '<th class="' + $col.prop ('class') + '">';
						th += '<input type="text" class="form-control input-sm ' + showFilter + '" placeholder="' + $col.text () + '">';
						th += '</th>';
						$row.append (th);
					}

					$row.find ('th').removeClass ('sorting sorting_disabled sorting_asc sorting_desc sorting_asc_disabled sorting_desc_disabled');

					$thisTable.find ('thead input').keyup( function () {
						$thisTable.fnFilter( this.value, $thisTable.oApi._fnVisibleToColumnIndex( 
							$thisTable.fnSettings(), $thisTable.find ('thead input[type=text]').index(this) ) );
					});

					$thisTable.addClass ('datatable-columnfilter');
				}
			});

			$('.dataTables_filter input').prop ('placeholder', 'Search...');
		}
	}

	function debounce (func, wait, immediate) {
		var timeout, args, context, timestamp, result;
		return function() {
			context = this;
			args = arguments;
			timestamp = new Date();

			var later = function() {
				var last = (new Date()) - timestamp;

				if (last < wait) {
					timeout = setTimeout(later, wait - last);
				} else {
					timeout = null;
					if (!immediate) result = func.apply(context, args);
				}
			};

			var callNow = immediate && !timeout;

			if (!timeout) {
				timeout = setTimeout(later, wait);
			}

			if (callNow) result = func.apply(context, args);
			return result;
		};
	}
}();

//Bootstrap 3 Modal Vertically Centered http://cdpn.io/mKfCc
function initModalCentered (){
	$('.modal').each(function(){
	    if($(this).hasClass('in') == false){
	      $(this).show();
	    };
	    var contentHeight = $(window).height() - 60;
	    var headerHeight = $(this).find('.modal-header').outerHeight() || 2;
	    var footerHeight = $(this).find('.modal-footer').outerHeight() || 2;

	    $(this).find('.modal-content').css({
	      'max-height': function () {
	        return contentHeight;
	      }
	    });

	    $(this).find('.modal-body').css({
	      'max-height': function () {
	        return contentHeight - (headerHeight + footerHeight);
	      }
	    });

	    $(this).find('.modal-dialog').addClass('modal-dialog-center').css({
	      'margin-top': function () {
	        return -($(this).outerHeight() / 2);
	      },
	      'margin-left': function () {
	        return -($(this).outerWidth() / 2);
	      }
	    });
	    if($(this).hasClass('in') == false){
	      $(this).hide();
	    };
	});
};
if ($(window).height() >= 320){
  $(window).resize(initModalCentered).trigger("resize");
}

$(function () {
	App.init ();
	initModalCentered();
});
